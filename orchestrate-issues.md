# todo-orchestrate v0.1 — Orchestration Issues & Actions

> Run: 2025-10-13T22:34Z • ID: 202510132234 • Task: `todos/cli-migration/cli-improvements.md`
>
> Branch: `feature/cli-migration-cli-improvements`
>
> Worktree: `.worktrees/202510132234-cli-migration-cli-improvements`
>
> Workspace: `.worktrees/202510132234-cli-migration-cli-improvements/.workspace/orchestrate/202510132234-cli-migration-cli-improvements`

## Summary

- INIT completed: worktree, workspace, spec, metadata, and notes created.
- Two commit attempts were affected by pre-commit formatting (Prettier) and required re-stage + commit.
- INSPECT was blocked by missing `cdx-exec`; a stub result was written to keep artifacts flowing.
- Initial INSPECT attempt briefly used Python for JSON parsing; this caused avoidable errors and was replaced with bash-only logic.

## Issues Encountered

1. Pre-commit formatting modified files and aborted commit

- Symptom: `prettier ... files were modified by this hook` on commit for:
  - `.workspace/.../session-notes.md` (INIT)
  - `.workspace/.../inspect/digest.md` (INSPECT)
- Cause: Repository’s pre-commit configuration formats Markdown and exits non‑zero when it changes files.
- Actions tried:
  - Re-staged modified files and committed again (passed).
  - Used non-interactive commits (`GIT_EDITOR=true git commit -m ...`).
- Outcome: Commits succeeded after re-stage; no config changes were made (respecting quality gates).
- Recommendation: Pre-run formatting when generating artifacts to avoid a second commit cycle, e.g. `pre-commit run -a` after file creation. Do not relax or bypass hooks.

2. JSON parsing via Python in a bash step (unnecessary + error-prone)

- Symptom: `IndexError: list index out of range` and `Permission denied` while attempting to read `orchestration-meta.json`.
- Causes:
  - Used `python -` with `sys.argv[1]`; no argv was passed → `IndexError`.
  - A quoting/word-splitting mistake led the shell to interpret the JSON path as an executable → `Permission denied`.
- Actions tried:
  - Removed Python from the step per guidance; rewrote the logic in pure bash.
  - Collected the latest worktree/workspace via `ls -dt` globs.
- Outcome: Proceeded without Python; INSPECT step executed to completion (stub path).
- Recommendation: Prefer `jq` for JSON fields (e.g., `jq -r .branch "$META"`) and otherwise keep steps bash-only. Mandate `jq` as a tool dependency rather than ad‑hoc parsing.

3. `cdx-exec` not found on PATH

- Symptom: `ERROR: cdx-exec not found on PATH.` during INSPECT.
- Actions tried:
  - Wrote a stub `inspect/full.md` explaining the missing dependency so downstream stages can still receive artifacts.
  - Probed for Codex CLI alternative: `codex` was present (`EXEC_CLI='codex exec'`).
- Outcome: INSPECT artifacts were created (stub + digest) and committed after formatting. `cdx-exec` remains unavailable.
- Recommendation: Standardize on a single CLI. Either:
  - Require `codex` and update orchestration commands to `codex exec ...`, or
  - Install the `cdx-exec` shim alongside Codex CLI and document it as required.
    Do not implement runtime fallbacks; choose one canonical interface and enforce it.

4. Fragile run directory discovery pattern

- Observation: Current scripts derive the “latest run” via `ls -dt .worktrees/*-<slug> | head -n1`. This works but is brittle with concurrent runs.
- Action taken: Proceeded with this approach for the single run.
- Recommendation: Source paths from the already-written `orchestration-meta.json` (e.g., `worktree_dir`, `workspace_dir`) via `jq`. This removes glob/race risk and avoids guessing.

## What Worked

- Git worktrees for isolated orchestration runs.
- Committing after re-stage when pre-commit reformats files.
- Bash-only implementation for INSPECT flow control and artifact persistence.

## What Didn’t Work

- Inline Python (`python -`) for JSON parsing in bash steps.
- Assuming `cdx-exec` exists on PATH in this environment.

## Decisions & Next Steps

- Keep respecting pre-commit hooks; do not alter quality gates.
- Adopt `jq` as a required dependency for reading orchestration metadata.
- Pick a single Codex CLI entrypoint and document it (prefer `codex exec` since it exists here); update orchestration scripts accordingly in a follow-up change.
- For future runs, pre-run `pre-commit run -a` on generated artifacts before the first commit to reduce churn.

---

Generated by the `todo-orchestrate` attempt on 2025-10-13.
