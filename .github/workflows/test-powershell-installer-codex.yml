name: Windows PowerShell Installer Testing - Codex

on:
  push:
    paths:
      - "shared/tests/integration/test_powershell_installer_codex.ps1"
      - ".github/workflows/test-powershell-installer-codex.yml"
  pull_request:
    paths:
      - "shared/tests/integration/test_powershell_installer_codex.ps1"
      - ".github/workflows/test-powershell-installer-codex.yml"
  workflow_dispatch:

jobs:
  test-powershell-installer:
    name: Codex PS Installer (${{ matrix.os }} / PS ${{ matrix.powershell_version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2022
            powershell_version: "7.x"
          - os: windows-latest
            powershell_version: "7.x"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: PowerShell/PowerShell@v1
        with:
          version: ${{ matrix.powershell_version }}

      - name: Print environment
        shell: powershell
        run: |
          Write-Output "OS: $env:OS"
          Write-Output "Runner: $env:RUNNER_OS"
          Write-Output "PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Output "Working Dir: $(Get-Location)"

      - name: Run PowerShell Installer Tests (Codex)
        shell: powershell
        env:
          MATRIX_OS: ${{ matrix.os }}
        run: |
          $testScript = "shared/tests/integration/test_powershell_installer_codex.ps1"
          if (Test-Path $testScript) {
            Write-Output "Running Codex PowerShell installer tests..."
            & pwsh -File $testScript -Verbose
          } else {
            Write-Output "Test script not found. Running basic validation..."
            $installerScript = "codex/install.ps1"
            if (Test-Path $installerScript) {
              & $installerScript -? | Out-Host
              & $installerScript -DryRun -Verbose | Out-Host
            } else {
              Write-Error "Installer script not found: $installerScript"
            }
          }

      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-powershell-core-codex
          path: |
            ${{ runner.temp }}/ai-workflows-install.log
            ${{ runner.temp }}/powershell-installer-test/
