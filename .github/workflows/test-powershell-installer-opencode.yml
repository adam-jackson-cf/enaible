name: Windows PowerShell Installer Testing - OpenCode

on:
  push:
    branches: [main, develop]
    paths:
      - "opencode/install.ps1"
      - "opencode/**"
      - "shared/tests/integration/test_powershell_installer_opencode.ps1"
      - ".github/workflows/test-powershell-installer-opencode.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "opencode/install.ps1"
      - "opencode/**"
      - "shared/tests/integration/test_powershell_installer_opencode.ps1"
      - ".github/workflows/test-powershell-installer-opencode.yml"
  workflow_dispatch:
    inputs:
      test_scenario:
        description: "Test scenario to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - fresh-install
          - merge-mode
          - update-workflows
          - error-handling
          - performance

jobs:
  test-powershell-installer:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, windows-latest]
        include:
          - os: windows-2022
            powershell_version: "7.x"
            shell: "pwsh"
          - os: windows-latest
            powershell_version: "7.x"
            shell: "pwsh"

    runs-on: ${{ matrix.os }}

    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for testing

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "18"

      - name: Install OpenCode CLI (mock for testing)
        shell: powershell
        run: |
          # Create a mock opencode command for testing
          $opencodeDir = "$env:USERPROFILE\.opencode-cli"
          $opencodeBin = "$opencodeDir\opencode.exe"
          New-Item -ItemType Directory -Path $opencodeDir -Force | Out-Null

          # Create a simple batch file that mimics opencode cli
          @"
          @echo off
          if "%1"=="--version" (
              echo opencode-cli 1.0.0
              exit /b 0
          )
          if "%1"=="mcp" (
              if "%2"=="list" (
                  echo No MCP servers configured
                  exit /b 0
              )
              if "%2"=="add" (
                  echo MCP server %4 added successfully
                  exit /b 0
              )
          )
          echo Unknown command: %*
          exit /b 1
          "@ | Out-File -FilePath "$opencodeDir\opencode.bat" -Encoding ASCII

          # Add to PATH for this session
          $env:PATH = "$opencodeDir;$env:PATH"
          [Environment]::SetEnvironmentVariable("PATH", "$opencodeDir;$env:PATH", "Process")

          # Verify mock installation
          opencode --version

      - name: Install test dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pyyaml requests

          # Install npm packages for testing
          npm install -g eslint @typescript-eslint/parser

      - name: Display environment info
        run: |
          Write-Output "PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Output "OS: $env:OS"
          Write-Output "Architecture: $env:PROCESSOR_ARCHITECTURE"
          Write-Output "Python: $(python --version)"
          Write-Output "Node.js: $(node --version)"
          Write-Output "npm: $(npm --version)"

          # Test opencode mock
          try {
              $opencodeVersion = opencode --version
              Write-Output "OpenCode CLI (mock): $opencodeVersion"
          } catch {
              Write-Output "OpenCode CLI: Not available"
          }

      - name: Run PowerShell Installer Tests
        env:
          TEST_SCENARIO: ${{ github.event.inputs.test_scenario || 'all' }}
          CI_ENVIRONMENT: "github-actions"
          MATRIX_OS: ${{ matrix.os }}
          MATRIX_POWERSHELL: "powershell-core"
        run: |
          # Set execution policy for testing
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force

          # Run the test suite
          $testScript = "shared/tests/integration/test_powershell_installer_opencode.ps1"
          if (Test-Path $testScript) {
              Write-Output "Running OpenCode PowerShell installer tests..."
              & $testScript -TestScenario $env:TEST_SCENARIO -Verbose
          } else {
              Write-Output "Test script not found: $testScript"
              Write-Output "Available files in shared/tests/integration/:"
              Get-ChildItem "shared/tests/integration/" -ErrorAction SilentlyContinue | ForEach-Object { Write-Output "  $($_.Name)" }

              Write-Output "Running basic installer validation instead..."

              # Basic validation of install.ps1
              $installerScript = "opencode/install.ps1"
              if (Test-Path $installerScript) {
                  Write-Output "Testing installer help:"
                  & $installerScript -Help

                  Write-Output "Testing installer dry run:"
                  & $installerScript -DryRun -Verbose
              } else {
                  Write-Error "Installer script not found: $installerScript"
                  exit 1
              }
          }

      - name: Collect diagnostic information
        if: failure()
        run: |
          Write-Output "=== Diagnostic Information ==="
          Write-Output "PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Output "Execution Policy: $(Get-ExecutionPolicy)"
          Write-Output "Current Directory: $(Get-Location)"
          Write-Output "Available Modules:"
          Get-Module -ListAvailable | Select-Object Name, Version | Format-Table

          Write-Output "Environment Variables:"
          Get-ChildItem env: | Where-Object { $_.Name -match "(PATH|TEMP|USER)" } | Format-Table

          # Check for log files
          $logFile = "$env:TEMP\ai-workflows-install.log"
          if (Test-Path $logFile) {
              Write-Output "Installation Log Content:"
              Get-Content $logFile | Write-Output
          }

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-powershell-core-opencode
          path: |
            ${{ runner.temp }}/ai-workflows-install.log
            ${{ runner.temp }}/powershell-installer-test/
          retention-days: 7
