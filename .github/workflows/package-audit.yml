name: Package Audit

on:
  pull_request:
    paths:
      - "requirements*.txt"
      - "requirements-dev.txt"
      - "pyproject.toml"
      - "Pipfile*"
      - "setup.py"
      - "setup.cfg"
  workflow_dispatch:
    inputs:
      audit-level:
        description: "Audit severity level"
        required: false
        default: "critical"
        type: choice
        options:
          - info
          - low
          - moderate
          - high
          - critical

jobs:
  audit-changed-packages:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0

      - name: Detect changed package files
        id: changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            python:
              - 'requirements*.txt'
              - 'requirements-dev.txt'
              - 'pyproject.toml'
              - 'Pipfile*'
              - 'setup.py'
              - 'setup.cfg'

      - name: Audit Python (if changed)
        if: steps.changes.outputs.python == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          pip-audit --vulnerability-service osv --strict || {
            # Only fail on CRITICAL vulnerabilities
            pip-audit --format json --output audit.json
            if jq -e '.vulnerabilities[] | select(.severity == "CRITICAL")' audit.json > /dev/null; then
              echo "Critical Python vulnerabilities found"
              exit 1
            fi
            exit 0
          }

      - name: Comment on PR if critical issues found
        if: failure()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          AUDIT_LEVEL: ${{ inputs.audit-level || 'critical' }}
        with:
          script: |
            const auditLevel = process.env.AUDIT_LEVEL;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `â›” Critical security vulnerabilities detected in dependencies (audit level: ${auditLevel}). Please review and fix before merging.`
            });
